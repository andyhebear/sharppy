\#include "sharppy.h"
#for $i in $exp_class.includes
\#include <$i>
#end for

#from TemplateHelpers import getCPlusPlusName, getCallbackTypedefName, makeCPlusPlusTypedef

#if $exp_class.hasVirtualMethods()
#set $base_list = ['public %s' % getCPlusPlusName(x) for x in $exp_class.bases]
#set $bases = ', '.join($base_list)
class SHARPPY_API $exp_class.bridge_name : $bases
{
public:
#for $c in $exp_class.constructors

#set $p = ', '.join(['%s %s' % (getCPlusPlusName(x[0]), x[1]) for x in $c.parameters])
#set $arg_list = ', '.join([x[1] for x in $c.parameters])
#set $base_cons = getCPlusPlusName($exp_class.bases[0])
   ${exp_class.bridge_name}($p)
      : ${base_cons}($arg_list)
   {;}
#end for

   virtual ~${exp_class.bridge_name}()
   {;}

#for $m in $exp_class.virtual_methods

   $makeCPlusPlusTypedef($m.callback);
   $getCallbackTypedefName($m.callback) ${m.name[0]}_callback;

#set $p = ', '.join(['%s %s' % (getCPlusPlusName(x[0]), x[1]) for x in $m.parameters])
#set $arg_list = ', '.join([x[1] for x in $m.parameters])
   virtual $getCPlusPlusName($m.result) ${m.name[0]}($p)
   {
#set $result_type = getCPlusPlusName($m.result)
      #if $result_type != 'void' then 'return' else ''# ${m.name[0]}_callback($arg_list);
   }
#end for
};
#end if

extern "C"
{
#for $c in $exp_class.constructors
#set $p = ', '.join(['%s %s' % (getCPlusPlusName(x[0]), x[1]) for x in $c.parameters])
   $exp_class.getCPlusPlusName()* new_${exp_class.bridge_name}($p
#for $i in range(len($exp_class.virtual_methods))
#set $q = '%s cb%s' % (getCallbackTypedefName($exp_class.virtual_methods[$i].callback, True), $i)
      , $q
#end for
      )
   {
#set $arg_list = ', '.join([x[1] for x in $c.parameters])
      $exp_class.bridge_name* obj = new ${exp_class.bridge_name}($arg_list);
#set $count = 0
#for $m in $exp_class.virtual_methods
      obj->${m.name[0]}_callback = cb$count;
#set $count = $count + 1
#end for
      return ($exp_class.getCPlusPlusName()*) obj;
   }

#end for

#if $exp_class.hasDestructor() or $exp_class.hasVirtualMethods()
   void delete_${exp_class.bridge_name}($exp_class.getCPlusPlusName()* self_)
   {
      delete self_;
   }

#end if

#for $m in $exp_class.non_virtual_methods
#set $params = ['%s %s' % (getCPlusPlusName(x[0]), x[1]) for x in $m.parameters]
#silent $params[0:0] = ["%s* self_" % $exp_class.getCPlusPlusName()]
#set $p = ', '.join($params)
#set $arg_list = ', '.join([x[1] for x in $m.parameters])
   ## XXX: Need to handle marshaling the return type here.
   $getCPlusPlusName($m.result) ${m.getGenericName()}($p)
   {
#if $getCPlusPlusName($m.result) != 'void'
#if $m.result.must_marshal
      return new ${getCPlusPlusName(m.result)}(self_->${m.getGenericName()}($arg_list));
#else
      return self_->${m.getGenericName()}($arg_list);
#end if
#else
      self_->${m.getGenericName()}($arg_list);
#end if
   }

#end for

#*
#for $m in $exp_class.virtual_methods
   $m.result.marshal_type ${exp_class.bridge_name}_${m.getGenericName()}($exp_class.type* self_,
      ', '.join($m.parameters))
   {
#if $m.result != 'void'
#set $p = ', '.join(['::'.join(x[0].name) for x in $m.parameters])
#if $m.result.mustMarshal()
      return new ${m.result}(self_->$exp_class.type::${m.getGenericName()}($p));
#else
      return self_->$exp_class.type::${m.getGenericName()}(', '.join($p));
#end if
#else
      self_->$exp_class.type::${m.getGenericName()}(', '.join($p));
#end if
   }

#end for

#for $m in $exp_class.static_methods
   $m.result.marshal_type ${exp_class.getGenericName()}_${m.getGenericName()}(', '.join($m.parameters))
   {
#if $m.result != 'void'
#set $p = ', '.join(['::'.join(x[0].name) for x in $m.parameters])
#if $m.result.must_marshal
      return new ${m.result}($exp_class.type::${m.getGenericName()}($p));
#else
      return $exp_class.type::${m.getGenericName()}(', '.join($p));
#end if
#else
      $exp_class.type::${m.getGenericName()}(', '.join($p));
#end if
   }

#end for
*#
}
